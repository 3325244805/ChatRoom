<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天系统</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome图标 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 自定义Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E293B',
                        accent: '#10B981',
                        dark: '#0F172A',
                        light: '#334155',
                        text: '#E2E8F0'
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .chat-scrollbar::-webkit-scrollbar {
                width: 6px;
            }
            .chat-scrollbar::-webkit-scrollbar-track {
                background: #1E293B;
                border-radius: 8px;
            }
            .chat-scrollbar::-webkit-scrollbar-thumb {
                background: #334155;
                border-radius: 8px;
            }
            .scale-hover {
                transition: transform 0.2s ease;
            }
            .scale-hover:hover {
                transform: scale(1.03);
            }
        }
    </style>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease forwards;
        }
        .dropdown-enter {
            opacity: 0;
            transform: translateY(-10px);
        }
        .dropdown-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.2s ease;
        }
    </style>
</head>
<body class="bg-dark text-text min-h-screen flex items-center justify-center p-4">
<!-- 主容器 -->
<div class="w-full max-w-6xl h-[90vh] bg-dark rounded-2xl shadow-lg overflow-hidden flex flex-col md:flex-row p-2">
    <!-- 左侧面板 -->
    <div class="w-full md:w-80 bg-secondary rounded-xl overflow-hidden flex flex-col mr-0 md:mr-4">
        <!-- 顶部区域：头像和搜索 -->
        <div class="p-4 bg-light rounded-t-xl">
            <div class="flex items-center gap-3 mb-4">
                <!-- 用户头像区域 -->
                <div class="relative" id="userAvatarContainer">
                    <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary cursor-pointer scale-hover">
                        <i class="fa fa-user text-xl"></i>
                    </div>

                    <!-- 用户下拉菜单 -->
                    <div id="userDropdown" class="absolute left-0 mt-2 w-48 bg-secondary rounded-lg shadow-lg border border-gray-700 dropdown-enter hidden z-10">
                        <div class="p-3 border-b border-gray-700">
                            <p class="font-medium text-sm" id="currentUserName">加载中...</p>
                        </div>
                        <div class="py-1">
                            <a href="#" class="block px-4 py-2 text-sm hover:bg-light transition-all-300">
                                <i class="fa fa-user-circle mr-2"></i>修改个人信息
                            </a>
                            <a href="#" class="block px-4 py-2 text-sm hover:bg-light transition-all-300">
                                <i class="fa fa-lock mr-2"></i>重置密码
                            </a>
                            <a href="/logout" class="block px-4 py-2 text-sm hover:bg-light transition-all-300 text-red-400">
                                <i class="fa fa-sign-out mr-2"></i>退出登录
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 搜索框 -->
                <div class="relative flex-1">
                    <input
                            type="email"
                            id="searchEmail"
                            placeholder="搜索联系人..."
                            class="w-full pl-10 pr-4 py-2 rounded-full bg-secondary border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm transition-all-300"
                    >
                    <i class="fa fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <!-- 添加联系人按钮 -->
                <button
                        onclick="openAddContactModal()"
                        class="bg-primary hover:bg-primary/90 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all-300 scale-hover"
                        title="添加联系人"
                >
                    <i class="fa fa-plus"></i>
                </button>
            </div>
        </div>

        <!-- 最近聊天区域 -->
        <div class="flex-1 overflow-y-auto chat-scrollbar p-2">
            <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                最近聊天
            </div>

            <!-- 最近聊天列表（预留） -->
            <div class="flex flex-col gap-1 mt-2">
                <!-- 空状态提示 -->
                <div class="py-12 px-4 text-center text-gray-400 animate-fadeIn">
                    <i class="fa fa-comments-o text-3xl mb-2 text-gray-600"></i>
                    <p class="text-sm">暂无聊天记录</p>
                    <p class="text-xs mt-1">添加联系人开始聊天吧</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 右侧对话框区域 -->
    <div class="flex-1 flex flex-col bg-secondary rounded-xl">
        <!-- 聊天头部 -->
        <div class="p-4 bg-light rounded-t-xl flex items-center justify-between border-b border-gray-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                    <i class="fa fa-user"></i>
                </div>
                <div>
                    <h3 class="font-medium text-sm">选择聊天对象</h3>
                    <p class="text-xs text-gray-400">离线</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button class="w-8 h-8 rounded-full hover:bg-gray-700 flex items-center justify-center text-gray-400 transition-all-300">
                    <i class="fa fa-phone"></i>
                </button>
                <button class="w-8 h-8 rounded-full hover:bg-gray-700 flex items-center justify-center text-gray-400 transition-all-300">
                    <i class="fa fa-video-camera"></i>
                </button>
                <button class="w-8 h-8 rounded-full hover:bg-gray-700 flex items-center justify-center text-gray-400 transition-all-300">
                    <i class="fa fa-ellipsis-v"></i>
                </button>
            </div>
        </div>

        <!-- 聊天内容区域 -->
        <div class="flex-1 overflow-y-auto chat-scrollbar bg-dark p-4">
            <!-- 空聊天状态 -->
            <div class="h-full flex flex-col items-center justify-center text-gray-400 animate-fadeIn">
                <div class="w-24 h-24 rounded-full bg-primary/10 flex items-center justify-center mb-4">
                    <i class="fa fa-comments text-4xl text-primary/30"></i>
                </div>
                <h4 class="font-medium text-gray-300 mb-1">还没有选择聊天对象</h4>
                <p class="text-xs text-gray-400 text-center max-w-xs">
                    使用左侧搜索框添加联系人，或从最近聊天中选择一个开始对话
                </p>
            </div>
        </div>

        <!-- 输入框区域 -->
        <div class="p-4 bg-light rounded-b-xl border-t border-gray-700">
            <div class="flex items-center gap-2">
                <button class="w-10 h-10 rounded-full hover:bg-gray-700 flex items-center justify-center text-gray-400 transition-all-300">
                    <i class="fa fa-smile-o"></i>
                </button>
                <button class="w-10 h-10 rounded-full hover:bg-gray-700 flex items-center justify-center text-gray-400 transition-all-300">
                    <i class="fa fa-paperclip"></i>
                </button>
                <input
                        type="text"
                        placeholder="输入消息..."
                        class="flex-1 py-2.5 px-4 rounded-full bg-secondary border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm transition-all-300"
                >
                <button class="bg-primary hover:bg-primary/90 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all-300 scale-hover">
                    <i class="fa fa-paper-plane-o"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 添加联系人弹窗 -->
<div id="addContactModal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center">
    <div class="bg-secondary rounded-xl w-full max-w-md p-6 relative animate-fadeIn">
        <!-- 关闭按钮 -->
        <button onclick="closeAddContactModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-all-300">
            <i class="fa fa-times"></i>
        </button>

        <!-- 弹窗标题 -->
        <h3 class="text-lg font-medium mb-4 flex items-center">
            <i class="fa fa-user-plus text-primary mr-2"></i>
            添加联系人
        </h3>

        <!-- 弹窗表单 -->
        <div class="space-y-4">
            <div>
                <label for="modalEmail" class="block text-xs text-gray-400 mb-1">联系人邮箱</label>
                <div class="relative">
                    <input
                            type="email"
                            id="modalEmail"
                            placeholder="请输入联系人邮箱地址"
                            class="w-full pl-4 pr-4 py-2.5 rounded-lg bg-dark border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm transition-all-300"
                    >
                </div>
            </div>

            <!-- 加载状态区域 -->
            <div id="modalLoading" class="hidden flex items-center justify-center py-2">
                <i class="fa fa-spinner fa-spin text-primary mr-2"></i>
                <span class="text-sm text-gray-300">正在搜索...</span>
            </div>

            <!-- 搜索结果区域 -->
            <div id="modalResult" class="hidden p-3 bg-light rounded-lg border border-gray-700">
                <div id="modalResultContent" class="text-sm"></div>
            </div>

            <!-- 按钮区域 -->
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddContactModal()" class="flex-1 py-2.5 rounded-lg bg-gray-700 hover:bg-gray-600 transition-all-300 text-sm">
                    取消
                </button>
                <button onclick="searchContactInModal()" class="flex-1 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-white transition-all-300 text-sm">
                    搜索并添加
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 隐藏元素存储当前用户ID -->
<input type="hidden" id="currentUserId" th:value="${session.userId}" />
<input type="hidden" id="currentUserName" th:value="${session.username}" />

<script>
    // 用户头像下拉菜单交互
    const avatarContainer = document.getElementById('userAvatarContainer');
    const userDropdown = document.getElementById('userDropdown');

    avatarContainer.addEventListener('click', (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle('hidden');
        if (!userDropdown.classList.contains('hidden')) {
            setTimeout(() => {
                userDropdown.classList.add('dropdown-enter-active');
            }, 10);
        } else {
            userDropdown.classList.remove('dropdown-enter-active');
        }
    });

    // 点击其他区域关闭下拉菜单
    document.addEventListener('click', () => {
        if (!userDropdown.classList.contains('hidden')) {
            userDropdown.classList.add('hidden');
            userDropdown.classList.remove('dropdown-enter-active');
        }
    });

    <!-- 初始化当前用户名 -->
    document.addEventListener('DOMContentLoaded', () => {
        // 从隐藏域获取用户名（修复：使用value属性正确获取）
        const userNameElement = document.getElementById('currentUserName');
        const userName = userNameElement ? userNameElement.value : '';

        // 获取显示用户名的元素
        const displayNameElement = document.querySelector('#userDropdown .font-medium');

        if (userName && displayNameElement) {
            displayNameElement.textContent = userName;
        } else if (displayNameElement) {
            // 如果没有获取到用户名，显示默认提示
            displayNameElement.textContent = '未登录';
        }
    });

    // 弹窗控制
    function openAddContactModal() {
        const modal = document.getElementById('addContactModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('modalEmail').value = '';
        document.getElementById('modalResult').classList.add('hidden');
        document.getElementById('modalLoading').classList.add('hidden');
        document.getElementById('modalEmail').focus();
    }

    function closeAddContactModal() {
        const modal = document.getElementById('addContactModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // 弹窗中搜索联系人
    function searchContactInModal() {
        const email = document.getElementById('modalEmail').value.trim();
        if (!email) {
            showToast('请输入邮箱地址', 'warning');
            return;
        }

        const currentUserId = document.getElementById('currentUserId').value;
        const modalLoading = document.getElementById('modalLoading');
        const modalResult = document.getElementById('modalResult');
        const modalResultContent = document.getElementById('modalResultContent');

        modalLoading.classList.remove('hidden');
        modalResult.classList.add('hidden');

        fetch(`/api/contact/search?email=${encodeURIComponent(email)}`, {
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                modalLoading.classList.add('hidden');
                modalResult.classList.remove('hidden');

                if (data.success && data.data) {
                    const user = data.data;

                    // 检查是否为当前用户
                    if (user.id.toString() === currentUserId) {
                        modalResultContent.innerHTML = `
                                <div class="py-2 text-center text-gray-400">
                                    <i class="fa fa-exclamation-circle mr-1"></i> 不能添加自己为联系人
                                </div>
                            `;
                        return;
                    }

                    modalResultContent.innerHTML = `
                            <div class="flex items-center gap-3 p-2 hover:bg-gray-700 rounded-lg transition-all-300 border border-gray-700">
                                <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary flex-shrink-0">
                                    <i class="fa fa-user"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm truncate">${user.username}</p>
                                    <p class="text-xs text-gray-400 truncate">${user.email}</p>
                                </div>
                                <button
                                    onclick="confirmAddContact(${user.id}, ${user.type})"
                                    class="bg-accent hover:bg-accent/90 text-white text-xs px-3 py-1 rounded-full transition-all-300 scale-hover"
                                >
                                    <i class="fa fa-check mr-1"></i> 确认添加
                                </button>
                            </div>
                        `;
                } else {
                    modalResultContent.innerHTML = `
                            <div class="py-2 text-center text-gray-400">
                                <i class="fa fa-search-minus mr-1"></i> 未找到该用户
                            </div>
                        `;
                }
            })
            .catch(error => {
                console.error('搜索失败:', error);
                modalLoading.classList.add('hidden');
                modalResult.classList.remove('hidden');
                modalResultContent.innerHTML = `
                        <div class="py-2 text-center text-red-500">
                            <i class="fa fa-exclamation-circle mr-1"></i> 搜索出错，请重试
                        </div>
                    `;
            });
    }

    // 确认添加联系人（弹窗内）
    function confirmAddContact(contactId, contactType) {
        fetch('/api/contact/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                contactId: contactId,
                contactType: contactType
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('联系人添加成功！', 'success');
                    closeAddContactModal();
                } else {
                    showToast(`添加失败: ${data.message || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                console.error('添加失败:', error);
                showToast('添加出错，请重试', 'error');
            });
    }

    // 搜索框搜索功能
    function searchUser() {
        const email = document.getElementById('searchEmail').value.trim();
        if (!email) {
            showToast('请输入邮箱地址', 'warning');
            return;
        }

        const currentUserId = document.getElementById('currentUserId').value;
        const resultDiv = document.getElementById('searchResult');
        const contentDiv = document.getElementById('resultContent');

        // 显示加载状态
        contentDiv.innerHTML = '<div class="flex items-center justify-center py-2"><i class="fa fa-spinner fa-spin text-primary mr-2"></i> 搜索中...</div>';
        resultDiv.style.display = 'block';

        fetch(`/api/contact/search?email=${encodeURIComponent(email)}`, {
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const user = data.data;

                    // 检查是否为当前用户
                    if (user.id.toString() === currentUserId) {
                        contentDiv.innerHTML = `
                                <div class="py-2 text-center text-gray-400">
                                    <i class="fa fa-exclamation-circle mr-1"></i> 不能添加自己为联系人
                                </div>
                            `;
                        return;
                    }

                    contentDiv.innerHTML = `
                            <div class="flex items-center gap-3 p-2 hover:bg-gray-700 rounded-lg transition-all-300 border border-gray-700">
                                <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary flex-shrink-0">
                                    <i class="fa fa-user"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm truncate">${user.username}</p>
                                    <p class="text-xs text-gray-400 truncate">${user.email}</p>
                                </div>
                                <button
                                    onclick="addContact(${user.id}, ${user.type})"
                                    class="bg-accent hover:bg-accent/90 text-white text-xs px-3 py-1 rounded-full transition-all-300 scale-hover"
                                >
                                    <i class="fa fa-user-plus mr-1"></i> 添加
                                </button>
                            </div>
                        `;
                } else {
                    contentDiv.innerHTML = `
                            <div class="py-2 text-center text-gray-400">
                                <i class="fa fa-search-minus mr-1"></i> 未找到该用户
                            </div>
                        `;
                }
            })
            .catch(error => {
                console.error('搜索失败:', error);
                contentDiv.innerHTML = `
                        <div class="py-2 text-center text-red-500">
                            <i class="fa fa-exclamation-circle mr-1"></i> 搜索出错，请重试
                        </div>
                    `;
            });
    }

    // 原有添加联系人功能
    function addContact(contactId, contactType) {
        fetch('/api/contact/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                contactId: contactId,
                contactType: contactType
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('联系人添加成功！', 'success');
                    document.getElementById('searchResult').style.display = 'none';
                    document.getElementById('searchEmail').value = '';
                } else {
                    showToast(`添加失败: ${data.message || '未知错误'}`, 'error');
                }
            })
            .catch(error => {
                console.error('添加失败:', error);
                showToast('添加出错，请重试', 'error');
            });
    }

    // 提示框功能
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        const iconMap = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        const colorMap = {
            success: 'bg-accent',
            error: 'bg-red-600',
            warning: 'bg-amber-600',
            info: 'bg-primary'
        };

        toast.className = `fixed bottom-4 right-4 ${colorMap[type]} text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 animate-fadeIn z-50`;
        toast.innerHTML = `
                <i class="fa ${iconMap[type]}"></i>
                <span class="text-sm">${message}</span>
            `;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(10px)';
            toast.style.transition = 'all 0.3s ease';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }

    // 键盘事件监听
    document.addEventListener('DOMContentLoaded', () => {
        // 搜索框回车触发搜索
        document.getElementById('searchEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchUser();
        });

        // 弹窗邮箱输入框回车触发搜索
        document.getElementById('modalEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchContactInModal();
        });

        // 点击弹窗外部关闭弹窗
        document.getElementById('addContactModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('addContactModal')) {
                closeAddContactModal();
            }
        });
    });
</script>
</body>
</html>